<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Force Layout with labels on edges</title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style type="text/css">
</style>
</head>
<body>
<div class="container"></div>
    <div id="menu" ></div>
    <div class="row">
	    <div id="graph" class="col-md-6"></div>
	    <div id="bar1" class="col-md-6"></div>
	    <div id="bar2" class="col-md-6"></div>
    </div>
    
</div>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/tooltip.js"></script>
<script type="text/javascript" src="js/vega2.js"></script> 
<!-- <script type="text/javascript" src="js/d3.js"></script> -->
<script type="text/javascript">

var indexData= function(searchNode) {
	var ind=dataset.nodes.map(function(f){return f.url}).indexOf(searchNode);
	if(ind!==-1) {
		return dataset.nodes[ind];
	}
  	return dataset.nodes[dataset.nodes.map(function(f){return f.url}).indexOf("Orphaned")]
}
var vega1=vega_bar(400,300,"#bar1");
var vega2=vega_bar(400,300,"#bar2");
      //vega2.setData("","p1");
      //vega2.render();
    var w = 700;
    var h = 600;
    var linkDistance=100;

    var colors = d3.scale.category10();

    var dataset = {
	    nodes: [
	    	{
	        url:"http://website1.com/",
			words: [ { w:'Bob', c:14 }, { w:'test', c:123}]
			},
			{
	        url:"http://website2.com/",
			words: [ { w:'taha', c:300 }, { w:'francesco', c:300}]
			},
			{
	        url:"http://website3.com/",
			words: [ { w:'denis', c:42 }, { w:'jw', c:120}]
			},
			{
	        url:"http://website4.com/",
			words: [ { w:'stefano', c:33 }, { w:'yonathan', c:500}]
			},
			{
	        url:"http://website5.com/",
			words: [ { w:'karina', c:140 }, { w:'khaleesi', c:60}]
			},
			{
	        url:"http://website6.com/",
			words: [ { w:'sun', c:180 }, { w:'test', c:30}]
			},
			{
	        url:"Orphaned",
			words: [ ]
			}
	    ],
	    edges: [
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website1.com/", 
	    		dest: "http://website2.com/",
	    		count: 100
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website1.com/", 
	    		dest: "http://website3.com/",
	    		count: 130
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website2.com/", 
	    		dest: "http://website4.com/",
	    		count: 234
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website3.com/", 
	    		dest: "http://website4.com/",
	    		count: 240
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website4.com/", 
	    		dest: "http://website5.com/",
	    		count: 300
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website4.com/", 
	    		dest: "http://website6.com/",
	    		count: 140
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website3.com/", 
	    		dest: "http://website6.com/",
	    		count: 175
	    	},
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website6.com/", 
	    		dest: "http://website3.com/",
	    		count: 200
	    	}
	    	,
	    	{
	    		source: 0, target: 0,
	    		srce: "http://website6.com/", 
	    		dest: "http://website77.com/",
	    		count: 200
	    	}
	    ]
	   

	}
 	

    var svg = d3.select("#graph").append("svg").attr({"width":w,"height":h});
    var strokeWidthScale = d3.scale.linear()
                    .domain([d3.min(dataset.edges, function(d) { return d.count; }),d3.max(dataset.edges, function(d) { return d.count; })])
                    .range([1, 7]);
    
    var force = d3.layout.force()
        .nodes(dataset.nodes)
        .links(dataset.edges)
        .size([w,h])
        .linkDistance([linkDistance])
        .charge([-500])
        .theta(0.1)
        .gravity(0.05)
        .start();

 

    var edges = svg.selectAll("line")
      .data(dataset.edges)
      .enter()
      .append("line")
      .attr("id",function(d,i) {return 'edge'+i})
      //.attr('marker-end','url(#arrowhead)')
      .style("stroke","#555")
      .style("stroke-width", function(d){ return strokeWidthScale(d.count)})
      .style("pointer-events", "none");
    
    var nodes = svg.selectAll("circle")
      .data(dataset.nodes)
      .enter()
      .append("circle")
      .attr({"r":15})
      .style("fill",function(d,i){return colors(i);})
      .call(force.drag)
      .on('click', function(d, i){ 
      	vega1.setData(d);
      	vega1.render(); })
      .on('mouseover', function(d, i){ 
      	vega2.setData(d);
      	vega2.render(); });



    var nodelabels = svg.selectAll(".nodelabel") 
       .data(dataset.nodes)
       .enter()
       .append("text")
       .attr({"x":function(d){return d.x;},
              "y":function(d){return d.y;},
              "class":"nodelabel",
              "stroke":"black"})
       .text(function(d){return d.url;});
       
    var edgepaths = svg.selectAll(".edgepath")
        .data(dataset.edges)
        .enter()
        .append('path')
        .attr({'d': function(d) {
          //console.log(d.source, dataset.nodes[dataset.nodes.map(function(f){return f.name}).indexOf(d.source1)]);
          var sr= indexData(d.srce);
          var tr= indexData(d.dest);
          //return 'M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y
          return 'M '+sr.x+' '+sr.y+' L '+ tr.x +' '+tr.y
        },
               'class':'edgepath',
               'fill-opacity':0,
               'stroke-opacity':0,
               'fill':'blue',
               'stroke':'red',
               'id':function(d,i) {return 'edgepath'+i}})
        .style("pointer-events", "none");

    var edgelabels = svg.selectAll(".edgelabel")
        .data(dataset.edges)
        .enter()
        .append('text')
        .style("pointer-events", "none")
        .attr({'class':'edgelabel',
               'id':function(d,i){return 'edgelabel'+i},
               'dx':80,
               'dy':0,
               'font-size':10,
               'fill':'#aaa'});

    edgelabels.append('textPath')
        .attr('xlink:href',function(d,i) {return '#edgepath'+i})
        .style("pointer-events", "none")
        .text(function(d,i){return d.count});


    svg.append('defs').append('marker')
        .attr({'id':'arrowhead',
               'viewBox':'-0 -5 10 10',
               'refX':25,
               'refY':0,
               //'markerUnits':'strokeWidth',
               'orient':'auto',
               'markerWidth':10,
               'markerHeight':10,
               'xoverflow':'visible'})
        .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#ccc')
            .attr('stroke','#ccc');
     

    force.on("tick", function(){
        edges.attr({"x1": function(d){return indexData(d.srce).x;},
                    "y1": function(d){return indexData(d.srce).y;},
                    "x2": function(d){return indexData(d.dest).x;},
                    "y2": function(d){return indexData(d.dest).y;}
        });

        nodes.attr({"cx":function(d){return d.x;},
                    "cy":function(d){return d.y;}
        });

        nodelabels.attr("x", function(d) { return d.x; }) 
                  .attr("y", function(d) { return d.y; });

        edgepaths.attr('d', function(d) { var path='M '+indexData(d.srce).x+' '+indexData(d.srce).y+' L '+ indexData(d.dest).x +' '+indexData(d.dest).y;
                                           //console.log(d)
                                           return path});       

        edgelabels.attr('transform',function(d,i){
            if (indexData(d.dest).x<indexData(d.srce).x){
                bbox = this.getBBox();
                rx = bbox.x+bbox.width/2;
                ry = bbox.y+bbox.height/2;
                return 'rotate(180 '+rx+' '+ry+')';
                }
            else {
                return 'rotate(0)';
                }
        });
    });

function vega_bar(w,h,div_id)
{
  	var that = {};
	var data_bar = new Array();
	var data1=null;
	var prop;
	that.setData = function(d) {
              	console.log(d);
                data1 = d.words;
    };

    that.getData = function() {
                  return data1;
    }

	that.render = function() {
		$(div_id).empty();
		var spec1 = 
		{
		  "width": w,
		  "height": h,
		  "padding": {"top": 10, "left": 30, "bottom": 30, "right": 10},
		  "data": [
		    {
		      "name": "table",
		      "values": data1
		    }
		  ],
		  "scales": [
		    {
		      "name": "x",
		      "type": "ordinal",
		      "range": "width",
		      "domain": {"data": "table", "field": "w"},
		      //"domainMin":true,
		      //"domainMax":true
		    },
		    {
		      "name": "y",
		      "range": "height",
		      "nice": true,
		      "domain": {"data": "table", "field": "c"}
		    }
		  ],
		  "axes": [
		    {"type": "x", "scale": "x"},
		    {"type": "y", "scale": "y"}
		  ],
		  "marks": [
		    {
		      "type": "rect",
		      "from": {"data": "table"},
		      "properties": {
		        "enter": {
		          "x": {"scale": "x", "field": "w"},
		          "width": {"scale": "x", "band": true, "offset": -1},
		          "y": {"scale": "y", "field": "c"},
		          "y2": {"scale": "y", "value": 0}
		        },
		        "update": {
		          "fill": {"value": "steelblue"}
		        },
		        "hover": {
		          "fill": {"value": "red"}
		        }
		      }
		    }
		  ]
		};

		var id = 20, timer = null;
		var renderer = "svg", animate = false, dur = 1000;
		vg.parse.spec(spec1, function(chart) {
		  self.view1 = chart({
		    el: div_id,
		    //data: data,
		    renderer: renderer,
		    hover: true
		  }).update();
		});
	}
return that;
}
</script>

</body>
</html>
    
   
